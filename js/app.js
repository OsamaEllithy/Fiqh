const data = {
    "شرب الخمر": { حكم: "حرام", دليل: "قال تعالى: {إِنَّمَا الْخَمْرُ وَالْمَيْسِرُ...} [المائدة: 90]", مرادفات: ["الخمر", "الكحول", "المسكرات", "شرب الكحول", "الخمور"] },
    "الصلاة": { حكم: "واجب", دليل: "قال تعالى: {إِنَّ الصَّلَاةَ كَانَتْ عَلَى الْمُؤْمِنِينَ كِتَابًا مَّوْقُوتًا}", مرادفات: ["أداء الصلاة", "صلاة الفرائض", "الصلوات"] },
    "صيام رمضان": { حكم: "واجب", دليل: "قال تعالى: {يَا أَيُّهَا الَّذِينَ آمَنُوا كُتِبَ عَلَيْكُمُ الصِّيَامُ...}", مرادفات: ["الصوم", "رمضان"] },
    "الربا": { حكم: "حرام", دليل: "قال تعالى: {يَا أَيُّهَا الَّذِينَ آمَنُوا لَا تَأْكُلُوا الرِّبَا...}", مرادفات: ["الفائدة", "الفوائد", "الربوية"] },
    "الزكاة": { حكم: "واجب", دليل: "قال تعالى: {وَأَقِيمُوا الصَّلَاةَ وَآتُوا الزَّكَاةَ}", مرادفات: ["زكاة المال", "الزكاة المفروضة"] },
    "حجاب المرأة": { حكم: "واجب", دليل: "قال تعالى: {وَقُل لِّلْمُؤْمِنَاتِ يَغْضُضْنَ مِنْ أَبْصَارِهِنَّ...}", مرادفات: ["النقاب", "الحشمة", "الستر"] },
    "الكذب": { حكم: "حرام", دليل: "قال النبي ﷺ: إياكم والكذب، فإن الكذب يهدي إلى الفجور...", مرادفات: ["الافتراء", "التضليل"] },
    "الغيبة": { حكم: "حرام", دليل: "قال تعالى: {وَلَا يَغْتَب بَّعْضُكُم بَعْضًا...}", مرادفات: ["النميمة", "التكلم في عرض الغائب"] },
    "السرقة": { حكم: "حرام", دليل: "قال تعالى: {وَالسَّارِقُ وَالسَّارِقَةُ فَاقْطَعُوا أَيْدِيَهُمَا...}", مرادفات: ["السطو", "الاختلاس"] },
    "بر الوالدين": { حكم: "واجب", دليل: "قال تعالى: {وَقَضَى رَبُّكَ أَلَّا تَعْبُدُوا إِلَّا إِيَّاهُ...}", مرادفات: ["الإحسان للوالدين", "طاعة الوالدين"] },
    "صوم الست من شوال": { حكم: "مستحب", دليل: "قال النبي ﷺ: من صام رمضان ثم أتبعه ستًا من شوال...", مرادفات: ["صيام شوال", "ستة أيام من شوال"] },
    "صلاة الوتر": { حكم: "سنة مؤكدة", دليل: "قال النبي ﷺ: أوتروا يا أهل القرآن...", مرادفات: ["الوتر"] },
    "صلاة التراويح": { حكم: "سنة", دليل: "قال النبي ﷺ: من قام رمضان إيمانًا واحتسابًا...", مرادفات: ["التراويح", "قيام رمضان"] },
    "التدخين": { حكم: "حرام", دليل: "لما فيه من ضرر على النفس، والقاعدة: لا ضرر ولا ضرار.", مرادفات: ["السجائر", "الشيشة"] },
    "السحر": { حكم: "حرام", دليل: "قال تعالى: {وَلَقَدْ عَلِمُوا لَمَنِ اشْتَرَاهُ مَا لَهُ فِي الْآخِرَةِ مِنْ خَلَاقٍ}", مرادفات: ["الشعوذة", "العرافة"] },
    "عقوق الوالدين": { حكم: "حرام", دليل: "قال تعالى: {فَلَا تَقُل لَّهُمَا أُفٍّ}، وقال النبي ﷺ: «إن من أكبر الكبائر: الإشراك بالله، وعقوق الوالدين...»", مرادفات: ["الإساءة للوالدين", "معصية الوالدين"] },
    "الصلاة في وقتها": { حكم: "واجب", دليل: "سُئل النبي ﷺ: أي العمل أحب إلى الله؟ قال: «الصلاة على وقتها»", مرادفات: ["صلاة الفرض", "الالتزام بالصلاة"] },
    "الوضوء قبل النوم": { حكم: "سنة مستحبة", دليل: "قال النبي ﷺ: «إذا أتيت مضجعك فتوضأ وضوءك للصلاة»", مرادفات: ["الوضوء للنوم"] },
    "الصلاة على النبي": { حكم: "واجبة في التشهد الأخير وسنة في غيره", دليل: "قال تعالى: {إِنَّ اللَّهَ وَمَلَائِكَتَهُ يُصَلُّونَ عَلَى النَّبِيِّ...}", مرادفات: ["الصلاة على الرسول", "اللهم صل على محمد"] },
    "صيام عاشوراء": { حكم: "سنة مؤكدة", دليل: "سُئل النبي ﷺ عن صوم يوم عاشوراء فقال: «يكفر السنة الماضية»", مرادفات: ["عاشوراء"] },
    "صيام يوم عرفة": { حكم: "سنة مؤكدة", دليل: "سُئل النبي ﷺ عن صوم يوم عرفة فقال: «يكفر السنة الماضية والباقية»", مرادفات: ["يوم عرفة"] },
    "النميمة": { حكم: "حرام", دليل: "قال النبي ﷺ: «لا يدخل الجنة نمام»", مرادفات: ["الوشاية", "نقل الكلام"] },
    "الوضوء": { حكم: "واجب", دليل: "قال تعالى: {يَا أَيُّهَا الَّذِينَ آمَنُوا إِذَا قُمْتُمْ إِلَى الصَّلَاةِ فَاغْسِلُوا وُجُوهَكُمْ...} [المائدة: 6]", مرادفات: ["الطهارة", "الغسل قبل الصلاة"] },
    "الجهر بالنية في الصلاة": { حكم: "بدعة", دليل: "قال النبي ﷺ: «إنما الأعمال بالنيات» ولم ينقل عنه الجهر بها.", مرادفات: ["النية بصوت عال"] },
    "أداء الأذان والإقامة": { حكم: "سنة مؤكدة", دليل: "قال النبي ﷺ: «إذا حضرت الصلاة فليؤذن لكم أحدكم وليؤمكم أكبركم» [رواه البخاري ومسلم]", مرادفات: ["الأذان", "الإقامة"] },
    "البيع والشراء": { حكم: "مباح (أصلًا)", دليل: "قال تعالى: {وَأَحَلَّ اللَّهُ الْبَيْعَ وَحَرَّمَ الرِّبَا} [البقرة: 275]", مرادفات: ["التجارة", "المعاملات التجارية"] },
    "الرشوة": { حكم: "حرام", دليل: "قال النبي ﷺ: «لعن الله الراشي والمرتشي» [رواه الترمذي وابن ماجه]", مرادفات: ["البرطيل", "المحسوبية غير المشروعة"] },
    "الغش في الميزان": { حكم: "حرام", دليل: "قال تعالى: {وَيْلٌ لِّلْمُطَفِّفِينَ} [المطففين: 1]", مرادفات: ["التحايل في الوزن", "التطفيف"] },
    "النظافة": { حكم: "واجبة (في بعض المواضع)", دليل: "قال النبي ﷺ: «الطهور شطر الإيمان» [رواه مسلم]", مرادفات: ["الطهور", "النظافة الشخصية"] },
    "السلام عند اللقاء": { حكم: "سنة", دليل: "قال النبي ﷺ: «أفشوا السلام بينكم» [رواه مسلم]", مرادفات: ["تحية السلام", "إلقاء السلام"] },
    "الحج": { حكم: "واجب على المستطيع", دليل: "قال تعالى: {وَلِلَّهِ عَلَى النَّاسِ حِجُّ الْبَيْتِ مَنِ اسْتَطَاعَ إِلَيْهِ سَبِيلًا} [آل عمران: 97]", مرادفات: ["فريضة الحج", "مناسك الحج"] },
    "العمرة": { حكم: "واجبة عند بعض العلماء وسنة مؤكدة عند آخرين", دليل: "قال النبي ﷺ: «العمرة إلى العمرة كفارة لما بينهما» [رواه البخاري ومسلم]", مرادفات: ["مناسك العمرة"] },
    "الجهاد": { حكم: "فرض كفاية وقد يصير فرض عين", دليل: "قال تعالى: {كُتِبَ عَلَيْكُمُ الْقِتَالُ وَهُوَ كُرْهٌ لَّكُمْ} [البقرة: 216]", مرادفات: ["القتال في سبيل الله", "الدفاع عن الدين"] },
    "العدل": { حكم: "واجب", دليل: "قال تعالى: {إِنَّ اللَّهَ يَأْمُرُ بِالْعَدْلِ وَالإِحْسَانِ} [النحل: 90]", مرادفات: ["الإنصاف", "المساواة"] },
    "الوفاء بالعهد": { حكم: "واجب", دليل: "قال تعالى: {وَأَوْفُوا بِالْعَهْدِ إِنَّ الْعَهْدَ كَانَ مَسْؤُولًا} [الإسراء: 34]", مرادفات: ["العهد", "الالتزام بالوعد"] },
    "الأمانة": { حكم: "واجب", دليل: "قال تعالى: {إِنَّ اللَّهَ يَأْمُرُكُمْ أَنْ تُؤدُّوا الأَمَانَاتِ إِلَى أَهْلِهَا} [النساء: 58]", مرادفات: ["حفظ الأمانات", "الوفاء بالأمانة"] },
    "قتل النفس": { حكم: "حرام", دليل: "قال تعالى: {وَلَا تَقْتُلُوا النَّفْسَ الَّتِي حَرَّمَ اللَّهُ إِلَّا بِالْحَقِّ} [الإسراء: 33]", مرادفات: ["القتل", "الاعتداء على النفس"] },
    "القصاص": { حكم: "واجب في القتل العمد إلا أن يعفو ولي الدم", دليل: "قال تعالى: {وَلَكُمْ فِي الْقِصَاصِ حَيَاةٌ} [البقرة: 179]", مرادفات: ["الثأر الشرعي", "القصاص في القتل"] },
    "الصدقة": { حكم: "مستحبة (واجبة في النذر)", دليل: "قال تعالى: {إِن تُقْرِضُوا اللَّهَ قَرْضًا حَسَنًا} [التغابن: 17]", مرادفات: ["التصدق", "الإنفاق في سبيل الله"] },
    "صلة الرحم": { حكم: "واجب", دليل: "قال النبي ﷺ: «من أحب أن يُبسط له في رزقه ويُنسأ له في أثره فليصل رحمه» [رواه البخاري]", مرادفات: ["بر الأقارب", "زيارة الأرحام"] },
    "الإحسان إلى الجار": { حكم: "واجب", دليل: "قال النبي ﷺ: «ما زال جبريل يوصيني بالجار حتى ظننت أنه سيورثه» [رواه البخاري ومسلم]", مرادفات: ["حق الجار", "معاملة الجيران"] },
    "الأضحية": { حكم: "سنة مؤكدة", دليل: "قال النبي ﷺ: «ما عمل آدمي من عمل يوم النحر أحب إلى الله من إهراق الدم» [رواه الترمذي]", مرادفات: ["ذبح الأضحية"] },
    "العقيقة": { حكم: "سنة مؤكدة", دليل: "قال النبي ﷺ: «كل غلام مرتهن بعقيقته، تذبح عنه يوم سابعه» [رواه أبو داود]", مرادفات: ["عقيقة المولود"] },
    "التيمم": { حكم: "واجب عند فقد الماء", دليل: "قال تعالى: {فَلَمْ تَجِدُوا مَاءً فَتَيَمَّمُوا صَعِيدًا طَيِّبًا} [المائدة: 6]", مرادفات: ["التيمم للصلاة", "البديل عن الوضوء"] },
    "الحياء": { حكم: "مستحب", دليل: "قال النبي ﷺ: «الحياء لا يأتي إلا بخير» [رواه البخاري]", مرادفات: ["الخجل", "الحشمة"] },
    "الأمر بالمعروف": { حكم: "واجب", دليل: "قال تعالى: {وَلْتَكُن مِّنكُمْ أُمَّةٌ يَدْعُونَ إِلَى الْخَيْرِ...} [آل عمران: 104]", مرادفات: ["الدعوة إلى الخير"] },
    "النهي عن المنكر": { حكم: "واجب", دليل: "قال النبي ﷺ: «من رأى منكم منكرًا فليغيره بيده...» [رواه مسلم]", مرادفات: ["منع الشر", "تغيير المنكر"] },
    "الوفاء بالنذر": { حكم: "واجب", دليل: "قال تعالى: {وَلْيُوفُوا نُذُورَهُمْ} [الحج: 29]", مرادفات: ["قضاء النذر"] },
    "الإفطار في رمضان بغير عذر": { حكم: "حرام", دليل: "قال النبي ﷺ: «من أفطر يومًا من رمضان من غير رخصة ولا مرض لم يقضه صوم الدهر»", مرادفات: ["تعمد الإفطار"] },
    "إطعام المسكين": { حكم: "مستحب (وقد يجب في الكفارة)", دليل: "قال تعالى: {أَوْ إِطْعَامٌ فِي يَوْمٍ ذِي مَسْغَبَةٍ، يَتِيمًا ذَا مَقْرَبَةٍ}", مرادفات: ["إطعام الفقراء"] },
    "المسح على الخفين": { حكم: "جائز", دليل: "قال النبي ﷺ: «رأيت رسول الله ﷺ يمسح على الخفين» [رواه البخاري]", مرادفات: ["المسح على الجوارب"] },
    "التوبة": { حكم: "واجب", دليل: "قال تعالى: {وَتُوبُوا إِلَى اللَّهِ جَمِيعًا أَيُّهَا الْمُؤْمِنُونَ} [النور: 31]", مرادفات: ["الاستغفار من الذنب", "الرجوع إلى الله"] },
    "الاستغفار": { حكم: "مستحب دائمًا", دليل: "قال تعالى: {وَاسْتَغْفِرُوا اللَّهَ إِنَّ اللَّهَ غَفُورٌ رَّحِيمٌ} [المزمل: 20]", مرادفات: ["طلب المغفرة"] },
    "الإعتكاف": { حكم: "سنة", دليل: "كان النبي ﷺ يعتكف العشر الأواخر من رمضان", مرادفات: ["الاعتكاف في المسجد"] },
    "صلاة الضحى": { حكم: "سنة", دليل: "قال النبي ﷺ: «يصبح على كل سلامى من أحدكم صدقة... ويجزئ عن ذلك ركعتان يركعهما من الضحى»", مرادفات: ["الضحى", "صلاة الأوابين"] },
    "إكرام الضيف": { حكم: "واجب يوم وليلة وسنة ثلاثة أيام", دليل: "قال النبي ﷺ: «من كان يؤمن بالله واليوم الآخر فليكرم ضيفه»", مرادفات: ["حق الضيف"] },
    "الاستئذان": { حكم: "واجب", دليل: "قال تعالى: {يَا أَيُّهَا الَّذِينَ آمَنُوا لَا تَدْخُلُوا بُيُوتًا غَيْرَ بُيُوتِكُمْ...} [النور: 27]", مرادفات: ["طلب الإذن"] },
    "النوم على طهارة": { حكم: "سنة", دليل: "قال النبي ﷺ: «إذا أتيت مضجعك فتوضأ وضوءك للصلاة» [رواه البخاري]", مرادفات: ["النوم متوضئاً"] },
    "الدعاء": { حكم: "مستحب دائمًا", دليل: "قال تعالى: {ادْعُونِي أَسْتَجِبْ لَكُمْ} [غافر: 60]", مرادفات: ["التضرع إلى الله", "طلب الحاجة من الله"] },
    "زيارة المريض": { حكم: "سنة", دليل: "قال النبي ﷺ: «عائد المريض في مخرفة الجنة حتى يرجع» [رواه مسلم]", مرادفات: ["عيادة المريض"] },
    "اتباع الجنائز": { حكم: "سنة", دليل: "قال النبي ﷺ: «من تبع جنازة حتى يصلى عليها فله قيراط...» [رواه البخاري]", مرادفات: ["تشييع الجنازة"] },
    "التكبير في العيدين": { حكم: "سنة", دليل: "قال تعالى: {وَلِتُكَبِّرُوا اللَّهَ عَلَى مَا هَدَاكُمْ} [البقرة: 185]", مرادفات: ["تكبيرات العيد"] },
    "إماطة الأذى عن الطريق": { حكم: "مستحب", دليل: "قال النبي ﷺ: «إماطة الأذى عن الطريق صدقة»", مرادفات: ["إزالة الضرر عن الطريق"] },
    "الصدق": { حكم: "واجب", دليل: "قال تعالى: {يَا أَيُّهَا الَّذِينَ آمَنُوا اتَّقُوا اللَّهَ وَكُونُوا مَعَ الصَّادِقِينَ} [التوبة: 119]", مرادفات: ["الأمانة في القول", "القول الصدق"] },
    "التواضع": { حكم: "مستحب", دليل: "قال النبي ﷺ: «وما تواضع أحد لله إلا رفعه» [رواه مسلم]", مرادفات: ["عدم التكبر"] },
    "التكبر": { حكم: "حرام", دليل: "قال النبي ﷺ: «لا يدخل الجنة من كان في قلبه مثقال ذرة من كبر»", مرادفات: ["الغرور", "التعالي"] },
    "الشرك بالله": { حكم: "أكبر الكبائر وحرام", دليل: "قال تعالى: {إِنَّ اللَّهَ لَا يَغْفِرُ أَن يُشْرَكَ بِهِ} [النساء: 48]", مرادفات: ["الإشراك بالله", "عبادة غير الله"] },
    "الحلف بغير الله": { حكم: "حرام", دليل: "قال النبي ﷺ: «من حلف بغير الله فقد أشرك» [رواه أبو داود]", مرادفات: ["الحلف بغير اسم الله"] },
    "التبرج": { حكم: "حرام", دليل: "قال تعالى: {وَلَا تَبَرَّجْنَ تَبَرُّجَ الْجَاهِلِيَّةِ الْأُولَى} [الأحزاب: 33]", مرادفات: ["إظهار الزينة"] },
    "الموسيقى والمعازف": { حكم: "مرتبط بالمختار الفقهي", دليل: "وردت أحاديث وآراء فقهاء اختلفت في التحريم، ولأنك طلبت دليل واحد فاذكرنا سياق السؤال", مرادفات: ["الغناء", "آلات الطرب"] },
    "الرباط في سبيل الله": { حكم: "سنة مؤكدة", دليل: "قال النبي ﷺ: «رباط يوم في سبيل الله خير من الدنيا وما عليها»", مرادفات: ["الرباط"] },
    "الإيثار": { حكم: "مستحب", دليل: "قال تعالى: {وَيُؤْثِرُونَ عَلَى أَنفُسِهِمْ وَلَوْ كَانَ بِهِمْ خَصَاصَةٌ} [الحشر: 9]", مرادفات: ["التفضيل", "تقديم الآخرين"] },
    "إعانة المحتاج": { حكم: "واجب كفاية", دليل: "قال النبي ﷺ: «من كان في حاجة أخيه كان الله في حاجته»", مرادفات: ["مساعدة المحتاج"] },
    "حسن الظن": { حكم: "مستحب", دليل: "قال النبي ﷺ: «إياكم والظن فإن الظن أكذب الحديث»", مرادفات: ["التفكير الإيجابي"] },
    "سوء الظن": { حكم: "حرام", دليل: "قال تعالى: {اجْتَنِبُوا كَثِيرًا مِّنَ الظَّنِّ} [الحجرات: 12]", مرادفات: ["الظن السيء"] },
    "الطيرة والتشاؤم": { حكم: "حرام", دليل: "قال النبي ﷺ: «الطيرة شرك»", مرادفات: ["التطير", "التشاؤم"] },
    "التوكل على الله": { حكم: "واجب", دليل: "قال تعالى: {وَعَلَى اللَّهِ فَتَوَكَّلُوا إِن كُنتُم مُّؤْمِنِينَ} [المائدة: 23]", مرادفات: ["الاعتماد على الله"] },
    "الرقية الشرعية": { حكم: "جائزة", دليل: "قال النبي ﷺ: «لا بأس بالرقى ما لم تكن شركًا»", مرادفات: ["الرقية", "التعوذ"] },
    "إحياء سنة مهجورة": { حكم: "مستحب", دليل: "قال النبي ﷺ: «من أحيا سنة من سنتي قد أميتت بعدي فله أجرها...»", مرادفات: ["إعادة إحياء السنة"] },
    "صلاة الفجر": { حكم: "واجب", دليل: "قال تعالى: {فَاصْبَحُوا عَلَىٰ شُهُودِهِ} [النبأ: 9-11]", مرادفات: ["الفجر"] },
    "صلاة الظهر": { حكم: "واجب", دليل: "قال تعالى: {حَتَّىٰ بَاضَ الْفَجْرُ} دلالة على مواقيت الصلوات", مرادفات: ["الظهر"] },
    "صلاة العصر": { حكم: "واجب", دليل: "أمر بالصلاة على مواقيتها في عدة آيات والسنة", مرادفات: ["العصر"] },
    "صلاة المغرب": { حكم: "واجب", دليل: "ثبتت في القرآن والسنة مواقيت المغرب", مرادفات: ["المغرب"] },
    "تلاوة القرآن": { حكم: "واجب فضلاً", دليل: "قال تعالى: {وَرَتِّلِ الْقُرْآنَ تَرْتِيلًا} [المزمل: 4]", مرادفات: ["قراءة القرآن", "القرآن"] },
    "الزكاة المفروضة على المال": { حكم: "واجب", دليل: "قال تعالى: {خُذْ مِنْ أَمْوَالِهِم صَدَقَةً} [التوبة: 103]", مرادفات: ["زكاة الأموال"] },
    "القرض الحسن": { حكم: "مستحب/مباح", دليل: "حث الإسلام على الإحسان والإعارة بلا ربا", مرادفات: ["الدين", "الإقراض بدون فائدة"] },
    "البيع بالثمن المعلوم": { حكم: "واجب تجنبه للغرر", دليل: "النهي عن الغرر والشك في المعاملات في السنة", مرادفات: ["البيع بالغرر"] },
    "الشراكة": { حكم: "مباح مع شروط", دليل: "أحكام المعاملات في القرآن والسنة عامة للمعاملات المشروعة", مرادفات: ["التعاون التجاري"] },
    "الربا المعاملاتي": { حكم: "حرام", دليل: "قال تعالى: {وَأَحَلَّ اللَّهُ الْبَيْعَ وَحَرَّمَ الرِّبَا} [البقرة: 275]", مرادفات: ["التعامل الربوي"] },
    "الوصية": { حكم: "واجب بنسبة معينة", دليل: "قال تعالى: {يُوصِيكُمُ اللَّهُ فِي أَوْلَادِكُمْ} [النساء: 11]", مرادفات: ["الإيصاء"] },
    "الوصية للديون": { حكم: "مستحب", دليل: "السنة تأمر بالترتيب للديون والوصية", مرادفات: ["تسوية الديون"] },
    "النكاح (الزواج)": { حكم: "مشروع ومستحب", دليل: "قال تعالى: {وَمِنْ آيَاتِهِ أَنْ خَلَقَ لَكُم مِّنْ أَنفُسِكُمْ أَزْوَاجًا} [الروم: 21]", مرادفات: ["الزواج", "العقد الشرعي"] },
    "الولي في النكاح": { حكم: "لازم في بعض الحالات", دليل: "أوضحته السنة والأدلة الفقهية", مرادفات: ["ولي المرأة"] },
    "المهر": { حكم: "واجب على الزوج", دليل: "قال تعالى: {وَآتَيْتُمُوهُنَّ أُجُورَهُنَّ} [النساء: 4]", مرادفات: ["الصداق"] },
    "الطلاق": { حكم: "جائز لكن مكروه إن لم تكن ضرورة", دليل: "قال تعالى: {فَإِن طَلَّقَهَا فَلَا تَأْخُذُوا مِنْهُ شَيْئًا...} [البقرة: 229]", مرادفات: ["فسخ الزواج"] },
    "عدة المرأة المطلقة": { حكم: "واجب", دليل: "قال تعالى: {وَاللَّائِي يَئِسْنَ مِنَ الْمَحِيضِ} [الطلاق: 4]", مرادفات: ["العدة"] },
    "النفقة على الزوجة": { حكم: "واجب على الزوج", دليل: "قال تعالى: {وَعَلَى الْمَوْلُودِ لَهُ رِزْقُهُنَّ وَكِسْوَتُهُنَّ} دلالة على النفقة", مرادفات: ["حق الزوجة في النفقة"] },
    "حد الزنا (للزاني)": { حكم: "واجب تطبيقه بشروط", دليل: "آيات الحدود في القرآن وذكرها في السنة", مرادفات: ["عقوبة الزنا"] },
    "حد السرقة": { حكم: "واجب بشروط الشروط", دليل: "قال تعالى: {وَالسَّارِقُ وَالسَّارِقَةُ فَاقْطَعُوا أَيْدِيَهُمَا} [المائدة: 38]", مرادفات: ["عقوبة السرقة"] },
    "الحد على القذف": { حكم: "واجب عند الشروط", دليل: "قال تعالى: {وَالَّذِينَ يَرْمُونَ الْمُحْصَنَاتِ...} [النور: 4]", مرادفات: ["عقوبة القذف"] },
    "قواعد الإثبات": { حكم: "واجب اتباعها", دليل: "الكتاب والسنة يذكران شروط الشهادة والحق", مرادفات: ["شروط الشهادة"] },
    "الصدق في المعاملات": { حكم: "واجب", دليل: "قال النبي ﷺ: «عليكم بالصدق»", مرادفات: ["الأمانة في التعامل"] },
    "حفظ الأمانة في الوظيفة": { حكم: "واجب", دليل: "قال تعالى: {إِنَّ اللَّهَ يَأْمُرُكُمْ أَنْ تُؤدُّوا الأَمَانَاتِ إِلَى أَهْلِهَا} [النساء: 58]", مرادفات: ["الأمانة الوظيفية"] },
    "عدم الإساءة للآخرين لفظيًا": { حكم: "واجب", دليل: "قال تعالى: {وَقُولُوا لِلنَّاسِ حُسْنًا} [البقرة: 83]", مرادفات: ["القول الحسن"] },
    "صيانة العرض": { حكم: "واجب", دليل: "آيات الشرف والعفاف والأحاديث تحث على ذلك", مرادفات: ["حفظ الشرف"] },
    "الآذان": { حكم: "سنة مؤكدة", دليل: "قال النبي ﷺ: «حين تؤذن فحيث سمعت الأذان فأذن»", مرادفات: ["الآذان للصلاة"] },
    "الاستجابة للدعاء": { حكم: "واجب التوجه به", دليل: "قال تعالى: {ادْعُونِي أَسْتَجِبْ لَكُمْ} [غافر: 60]", مرادفات: ["قبول الدعاء"] },
    "الذكر بعد الصلاة": { حكم: "سنة", دليل: "السنة النبوية في الأذكار عقب الصلوات", مرادفات: ["أذكار ما بعد الصلاة"] },
    "التشهد": { حكم: "واجب في الصلاة", دليل: "السنة والنصوص على التشهد في الصلاة", مرادفات: ["التحيات"] },
    "الضمان (الكفالة)": { حكم: "جائز بشروط", دليل: "السنة والفقه تناولتا أحكام الكفالة والضمان", مرادفات: ["الكفالة"] },
    "الاستثمار الحلال": { حكم: "مباح مع شروط", دليل: "تحريم الربا وتحريم الحرام يجعل الاستثمار الحلال مشروعًا", مرادفات: ["الاستثمار غير الربوي"] },
    "المضاهاة في البيع": { حكم: "مستحب تجنبها", دليل: "النهي عن الغش والظلم في البيع في القرآن والسنة", مرادفات: ["الاحتكار"] },
    "غسل الميت": { حكم: "واجب على المسلمين بالنسبة لغير الحرم", دليل: "السنة في غسل وتكفين الميت", مرادفات: ["تغسيل الميت"] },
    "التكفين": { حكم: "واجب للميت المسلم", دليل: "السنة العملية المعروفة بغسل وكفن الميت", مرادفات: ["كفن الميت"] },
    "صلاة الجنازة": { حكم: "واجبة على الجماعة عند وجودها", دليل: "السنة في إقامة صلاة الجنازة", مرادفات: ["صلاة الميت"] },
    "الاستنجاء بعد النجاسة": { حكم: "واجب", دليل: "آيات الطهارة والسنة", مرادفات: ["تطهير النفس"] },
    "صيام يوم الاثنين والخميس": { حكم: "مستحب", دليل: "قال النبي ﷺ: «أحب الأعمال إلى الله أدومها وإن قل» ودعوة لصوم الاثنين والخميس", مرادفات: ["صيام الاثنين والخميس"] },
    "صيام أيام البيض": { حكم: "مستحب", دليل: "السنة في صيام أيام البيض (13،14،15 من الشهر القمري)", مرادفات: ["الأيام البيض"] },
    "الإفطار للمريض والمسافر": { حكم: "جائز ومباح", دليل: "قال تعالى: {فَمَن كَانَ مِنكُم مَرِيضًا أَوْ عَلَىٰ سَفَرٍ فَعِدَّةٌ مِّنْ أَيَّامٍ أُخَرَ} [البقرة: 184]", مرادفات: ["إفطار المريض", "إفطار المسافر"] },
    "الولاية على القاصر": { حكم: "واجب تطبيقها", دليل: "القرآن والسنة أوجبا حفظ الحقوق والوصاية", مرادفات: ["ولاية اليتيم"] },
    "الوصاية على المال": { حكم: "واجبة للحفاظ على مصلحة اليتيم", دليل: "قال تعالى: {وَآتوْا الْيَتَامَى أَمْوَالَهُمْ} [النساء: 2]", مرادفات: ["حفظ مال اليتيم"] },
    "إكرام الكبير في المجتمع": { حكم: "واجب", دليل: "السنة تحض على البر والإحسان إلى الكبير", مرادفات: ["احترام الكبير"] },
    "آداب الطعام (الذكر قبل الأكل)": { حكم: "سنة", دليل: "قال النبي ﷺ: «إذا أكل أحدكم فليذكر اسم الله تعالى»", مرادفات: ["التسمية قبل الأكل"] },
    "أكل بيمينه": { حكم: "سنة", دليل: "أوامر النبي ﷺ في آداب الأكل", مرادفات: ["الأكل باليد اليمنى"] },
    "الأكل مما بين يديك": { حكم: "سنة", دليل: "السنة في آداب الضيافة والأكل مع الناس", مرادفات: ["الأكل من طبقك"] },
    "التبرع بالدم": { حكم: "جائز ومندوب إذا لم يضر بالمتبرع", دليل: "القاعدة الشرعية: لا ضرر ولا ضرار", مرادفات: ["التبرع بالدم"] },
    "الزينة المشروعة": { حكم: "مباح ضمن الحلال", دليل: "الشرع يسمح بالزينة المشروعّة مع الضوابط", مرادفات: ["الحلية المباحة"] },
    "العمل باليد": { حكم: "مستحب وكفاح مشروع", دليل: "العمل عبادة في ضوء الأدلة العامة عن الكسب الحلال", مرادفات: ["الكسب الحلال"] },
    "حق الحياة": { حكم: "مقدس وواجب الحفاظ عليه", دليل: "قال تعالى: {وَمَنْ أَحْيَاهَا فَكَأَنَّمَا أَحْيَا النَّاسَ جَمِيعًا} [المائدة: 32]", مرادفات: ["حرمة الدم"] },
    "حق العرض والكرامة": { حكم: "واجب صيانتها", دليل: "القرآن والسنة يدافعان عن الكرامة الإنسانية", مرادفات: ["حفظ الأعراض"] },
    "الحق في المال": { حكم: "واجب الحفاظ عليه وعدم التعدي", دليل: "قال تعالى: {وَلَا تَأْكُلُوا أَمْوَالَكُم بَيْنَكُم بِالْبَاطِلِ} [البقرة: 188]", مرادفات: ["حفظ المال"] },
    "التيمم": { حكم: "واجب عند فقد الماء", دليل: "قال تعالى: {فَلَمْ تَجِدُوا مَاءً فَتَيَمَّمُوا صَعِيدًا طَيِّبًا} [المائدة: 6]", مرادفات: ["التيمم للصلاة", "البديل عن الوضوء"] },
    "الزكاة على الذهب": { حكم: "واجب عند النصاب", دليل: "تُخرَج زكاة الذهب إذا بلغ النصاب وحال عليه الحول.", مرادفات: ["زكاة الذهب"] },
    "النفقة": { حكم: "واجب", دليل: "قال تعالى: {عَلَى الْمَوْلُودِ لَهُ رِزْقُهُنَّ} ودلائل السنة.", مرادفات: ["النفقة الزوجية"] },
    "الطهارة": { حكم: "واجب", دليل: "قال النبي ﷺ: «الطهور شطر الإيمان»", مرادفات: ["الوضوء"] },
    "الاستغفار": { حكم: "مستحب", دليل: "قال تعالى: {وَاسْتَغْفِرُوا اللَّهَ}.", مرادفات: ["الاستغفار"] },
    "التوبة": { حكم: "واجب", دليل: "قال تعالى: {تُوبُوا إِلَى اللَّهِ جَمِيعًا}.", مرادفات: ["التوبة"] },
    "البيع بالغش": { حكم: "حرام", دليل: "النهي عن الخداع في البيع في الحديث والقرآن.", مرادفات: ["غش البيع"] },
    "المسواك": { حكم: "مستحب", دليل: "أمر به النبي ﷺ في سنته", مرادفات: ["السواك"] },
    "النية": { حكم: "أساسية (تقديرية)", دليل: "قال النبي ﷺ: «إنما الأعمال بالنيات»", مرادفات: ["النية"] },
    "التكافل الاجتماعي": { حكم: "واجب كفائي", دليل: "الدعوة للصدقة والإعانة في الكتاب والسنة", مرادفات: ["التضامن الاجتماعي"] },
    "حفظ الأمانة": { حكم: "واجب", دليل: "قال تعالى: {إِنَّ اللَّهَ يَأْمُرُكُمْ أَنْ تُؤدُّوا الأَمَانَاتِ} [النساء: 58]", مرادفات: ["الأمانة"] },
    "آداب الطعام": { حكم: "سنة", دليل: "ذكر النبي ﷺ آداباً مثل ذكر الله والأكل باليمين", مرادفات: ["آداب الأكل"] },
    "المسلم والمسيء": { حكم: "الرد بالقدوة الحسنة", دليل: "أخلاق النبي ﷺ في التعامل مع الناس", مرادفات: ["معاملة المسيء"] },
    "الإسلام في التعامل": { حكم: "واجب", دليل: "أدلة عامة في الكتاب والسنة على حسن الخلق", مرادفات: ["الأخلاق الإسلامية"] },
    "الحجاب": { حكم: "واجب على المرأة في حدود الشرع", دليل: "آيات مباشرة وأدلة النقل", مرادفات: ["الحجاب الشرعي"] },
    "الميراث": { حكم: "واجب تطبيقه", دليل: "أحكام الميراث موضوعة في القرآن في سورة النساء.", مرادفات: ["الإرث"] },
    "المهر": { حكم: "واجب على الزوج", دليل: "قال تعالى: {وَآتَيْتُمُوهُنَّ أُجُورَهُنَّ} [النساء: 4]", مرادفات: ["المهر"] },
    "الطلاق": { حكم: "مباح لكن مبغوض", دليل: "قال تعالى: {فَإِن طَلَّقَهَا فَلَا تَأْخُذُوا مِنْهُ شَيْئًا...} [البقرة: 229]", مرادفات: ["الطلاق"] },
    "عدة المرأة المطلقة": { حكم: "واجب", دليل: "قال تعالى: {وَاللَّائِي يَئِسْنَ مِنَ الْمَحِيضِ} [الطلاق: 4]", مرادفات: ["العدة"] },
    "الرشوة": { حكم: "حرام", دليل: "قال النبي ﷺ: «لعن الله الراشي والمرتشي»", مرادفات: ["الرشوة"] },
    "الصدقة": { حكم: "مستحب (واجبة في الزكاة)", دليل: "حث القرآن والسنة على الإنفاق", مرادفات: ["الصدقة"] },
    "الرهق (الكفالة)": { حكم: "جائز بشروط", دليل: "الفقه تناول أحكام الكفالة والضمان", مرادفات: ["الرهن"] },
    "النكاح (الزواج)": { حكم: "مشروع ومستحب", دليل: "قال تعالى: {وَمِنْ آيَاتِهِ أَنْ خَلَقَ لَكُم مِّنْ أَنفُسِكُمْ أَزْوَاجًا} [الروم: 21]", مرادفات: ["الزواج"] },
    "البيع والشراء": { حكم: "مباح", دليل: "قال تعالى: {أُحِلَّت لَكُم بَهِيمَةُ الْأَنْعَامِ... وَأَحَلَّ اللَّهُ الْبَيْعَ}.", مرادفات: ["البيع"] },
    "الربا": { حكم: "حرام", دليل: "قال تعالى: {يَا أَيُّهَا الَّذِينَ آمَنُوا لَا تَأْكُلُوا الرِّبَا...} [آل عمران/البقرة]", مرادفات: ["الربا"] },
    "السرقة": { حكم: "حرام", دليل: "قال تعالى: {وَالسَّارِقُ وَالسَّارِقَةُ فَاقْطَعُوا أَيْدِيَهُمَا} [المائدة: 38]", مرادفات: ["السرقة"] },
    "الوصية": { حكم: "واجب جزئياً (لوجود نصيب)", دليل: "قال تعالى: {يُوصِيكُمُ اللَّهُ فِي أَوْلَادِكُمْ} [النساء: 11]", مرادفات: ["الوصية"] },
    "صلة الرحم": { حكم: "واجب", دليل: "قال النبي ﷺ: «من أحب أن يُبسط له في رزقه... فليصل رحمه»", مرادفات: ["صلة الرحم"] },
    "الإحسان إلى الجار": { حكم: "واجب", دليل: "قال النبي ﷺ: «ما زال جبريل يوصيني بالجار...»", مرادفات: ["الإحسان للجار"] },
    "صلاة التراويح": { حكم: "سنة", دليل: "ثُبِتت صلاة التراويح في السنة النبوية.", مرادفات: ["التراويح"] },
    "صلاة الوتر": { حكم: "سنة مؤكدة", دليل: "قال النبي ﷺ: «أوتروا يا أهل القرآن...»", مرادفات: ["الوتر"] },
    "صيام رمضان": { حكم: "واجب", دليل: "قال تعالى: {كُتِبَ عَلَيْكُمُ الصِّيَامُ}.", مرادفات: ["رمضان"] },
    "صيام عاشوراء": { حكم: "سنة مؤكدة", دليل: "قال النبي ﷺ: «يكفر السنة الماضية»", مرادفات: ["عاشوراء"] },
    "صيام يوم عرفة": { حكم: "سنة مؤكدة", دليل: "قال النبي ﷺ: «يكفر السنة الماضية والباقية»", مرادفات: ["يوم عرفة"] },
    "الآذان": { حكم: "سنة مؤكدة", دليل: "السنة في الأذان والإقامة مثبتة بالمتواتر.", مرادفات: ["الآذان"] },
    "الغش في الميزان": { حكم: "حرام", دليل: "قال تعالى: {وَيْلٌ لِّلْمُطَفِّفِينَ} [المطففين: 1]", مرادفات: ["الغش"] },
    "قرض الحسن": { حكم: "مستحب", دليل: "الحث على الإعارة والإحسان دون ربا.", مرادفات: ["القرض الحسن"] },
    "التجارة": { حكم: "مباح بشرط الحلال", دليل: "البيع مشروع بشرط اجتناب الحرام.", مرادفات: ["التجارة الحلال"] },
    "الموسيقى": { حكم: "خلاف بين الفقهاء", دليل: "نبهت نصوص وأحاديث ونصائح فقهية مختلفة؛ يتطلب عرض أقوال الفقهاء", مرادفات: ["الغناء"] },
    "التبرج": { حكم: "حرام", دليل: "قال تعالى: {وَلَا تَبَرَّجْنَ} [الأحزاب:33]", مرادفات: ["التبرج"] },
    "صوم التطوع": { حكم: "مستحب", دليل: "قال النبي ﷺ: «من صام يومًا في سبيل الله باعد الله وجهه عن النار سبعين خريفاً»", مرادفات: ["الصيام المستحب", "صيام النوافل"] },
    "قراءة سورة الكهف يوم الجمعة": { حكم: "مستحب", دليل: "قال النبي ﷺ: «من قرأ سورة الكهف في يوم الجمعة أضاء له من النور ما بين الجمعتين»", مرادفات: ["سورة الكهف", "الكهف يوم الجمعة"] },
    "الزواج الثاني": { حكم: "مباح ومستحب عند الحاجة والعدل", دليل: "قال تعالى: {فَانكِحُوا مَا طَابَ لَكُم مِّنَ النِّسَاءِ مَثْنَىٰ وَثُلَاثَ وَرُبَاعَ} [النساء: 3]", مرادفات: ["التعدد", "الزواج بأكثر من واحدة"] },
    "التعامل مع غير المسلمين": { حكم: "مباح بحدود وشروط", دليل: "قال تعالى: {لَّا يَنْهَاكُمُ اللَّهُ عَنِ الَّذِينَ لَمْ يُقَاتِلُوكُمْ فِي الدِّينِ وَلَمْ يُخْرِجُوكُم مِّن دِيَارِكُمْ أَن تَبَرُّوهُمْ وَتُقْسِطُوا إِلَيْهِمْ} [الممتحنة: 8]", مرادفات: ["معاملة أهل الكتاب", "العلاقات مع غير المسلمين"] },
    "حلق اللحية للرجل": { حكم: "مختلف فيه (مكروه أو حرام عند بعض المذاهب)", دليل: "قال النبي ﷺ: «قصوا الشوارب وأعفوا اللحى» [رواه البخاري ومسلم]، ووردت آراء فقهاء مختلفة.", مرادفات: ["قص اللحية", "تخفيف اللحية"] },
    "صلاة الاستخارة": { حكم: "سنة", دليل: "عن جابر بن عبد الله رضي الله عنه قال: كان النبي ﷺ يعلمنا الاستخارة في الأمور كلها كما يعلمنا السورة من القرآن.", مرادفات: ["الاستخارة", "صلاة طلب الخيرة"] },
    "زيارة القبور": { حكم: "سنة للرجال، ومختلف فيه للنساء", دليل: "قال النبي ﷺ: «كنت نهيتكم عن زيارة القبور ألا فزوروها فإنها تذكركم الآخرة» [رواه مسلم]", مرادفات: ["زيارة المقابر"] },
    "الأمر بالمعروف والنهي عن المنكر (بشروطه)": { حكم: "واجب كفاية وقد يكون فرض عين", دليل: "قال تعالى: {كُنتُمْ خَيْرَ أُمَّةٍ أُخْرِجَتْ لِلنَّاسِ تَأْمُرُونَ بِالْمَعْرُوفِ وَتَنْهَوْنَ عَنِ الْمُنكَرِ} [آل عمران: 110]", مرادفات: ["الحسبة"] },
    "العقود المالية المشروعة": { حكم: "مباحة بضوابط الشريعة", دليل: "أحل الله البيع وحرم الربا، ووضع ضوابط للمعامالت مثل النهي عن الغرر والجهالة.", مرادفات: ["المعاملات المالية", "عقود البيع"] },
    "الوصية الواجبة": { حكم: "واجبة (لبعض العلماء)", دليل: "بعض الفقهاء يرونها واجبة للأقارب غير الوارثين الذين لا يرثون بسبب وجود حاجب.", مرادفات: ["الوصية للوارث المحجوب"] }
};

const keysCache = Object.keys(data);
let ttsEnabled = false;

function normalize(text) {
    if (!text) return '';
    text = text.toString().trim().toLowerCase();
    text = text.replace(/[\u064B-\u0652]/g, '');
    text = text.replace(/[^\u0621-\u064A0-9a-z\s]/g, '');
    text = text.replace(/[آأإ]/g, 'ا');
    text = text.replace(/ة/g, 'ه');
    text = text.replace(/ى/g, 'ي');
    text = text.replace(/\s+/g, ' ');
    return text;
}

function escapeHtml(text) {
    if (!text) return '';
    return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
}

function stripTags(str) {
    return (str || '').replace(/<\/?[^>]+(>|$)/g, "");
}

function showToast(msg, duration = 2200) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), duration);
}

function getRelatedSuggestions(key) {
    const related = [];
    const normalizedKeyWords = normalize(key).split(' ').filter(Boolean);

    for (const k of keysCache) {
        if (k === key) continue;

        const normalizedK = normalize(k);
        let matchCount = 0;

        for (const word of normalizedKeyWords) {
            if (word.length > 2 && normalizedK.includes(word)) {
                matchCount++;
            }
        }

        if (matchCount > 0 || normalizedK.includes(normalizedKeyWords.join(' '))) {
            if (!related.includes(k)) {
                related.push(k);
            }
        }
        if (related.length >= 4) break;
    }
    return related;
}

function renderResult(key) {
    if (!data[key]) {
        resultDiv.innerHTML = '<div class="welcome-message"><div class="mini">المسألة غير موجودة في قاعدة البيانات.</div></div>';
        return;
    }
    const item = data[key];
    resultDiv.innerHTML = '';
    const wrapper = document.createElement('div');
    wrapper.classList.add('hukm-card', 'animate__animated', 'animate__fadeIn');

    const hukmHeader = document.createElement('div');
    hukmHeader.className = 'hukm-header';
    const hukmTitle = document.createElement('div');
    hukmTitle.className = 'hukm-title';
    hukmTitle.textContent = key;
    const hukmType = document.createElement('div');
    hukmType.className = 'hukm-type';
    hukmType.textContent = item.حكم;
    hukmHeader.appendChild(hukmTitle);
    hukmHeader.appendChild(hukmType);

    const proof = document.createElement('div');
    proof.className = 'proof';
    proof.innerHTML = `<strong>الدليل:</strong><br>${escapeHtml(item.دليل)}`;

    const controls = document.createElement('div');
    controls.className = 'controls';
    const copyBtn = document.createElement('button');
    copyBtn.className = 'copy-btn';
    copyBtn.innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M19 21H8V7h11m0-2H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2m-3-4H4a2 2 0 0 0-2 2v14h2V3h12V1z"/></svg> نسخ';
    copyBtn.addEventListener('click', () => copyResultText(key));
    const ttsBtn = document.createElement('button');
    ttsBtn.className = 'copy-btn';
    ttsBtn.innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16"><path fill="currentColor" d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.8-1-3.3-2.5-4v8c1.5-.7 2.5-2.2 2.5-4zM14 3.2v2.1c2.9.9 5 3.5 5 6.7s-2.1 5.8-5 6.7v2.1c4-.9 7-4.5 7-8.8s-3-7.9-7-8.8z"/></svg> صوتي';
    ttsBtn.addEventListener('click', () => speakText(key));
    controls.appendChild(copyBtn);
    controls.appendChild(ttsBtn);

    wrapper.appendChild(hukmHeader);
    wrapper.appendChild(proof);
    wrapper.appendChild(controls);

    const related = getRelatedSuggestions(key);
    if (related.length) {
        const relBox = document.createElement('div');
        relBox.className = 'related-topics';
        const relTitle = document.createElement('span');
        relTitle.textContent = 'مواضيع ذات صلة:';
        relBox.appendChild(relTitle);
        related.forEach(r => {
            const b = document.createElement('button');
            b.className = 'suggestion';
            b.textContent = r;
            b.addEventListener('click', () => {
                questionInput.value = r;
                suggestionsDiv.innerHTML = '';
                renderResult(r);
            });
            relBox.appendChild(b);
        });
        wrapper.appendChild(relBox);
    }

    resultDiv.appendChild(wrapper);
}

function copyResultText(key) {
    const item = data[key];
    const text = `المسألة: ${key}\nالحكم: ${item.حكم}\nالدليل: ${stripTags(item.دليل)}`;
    document.execCommand('copy');
    showToast('تم نسخ النص إلى الحافظة');
}

function speakText(key) {
    if (!('speechSynthesis' in window)) {
        showToast('متصفحك لا يدعم تشغيل الصوت');
        return;
    }
    const item = data[key];
    const text = `الحكم في ${key}: ${item.حكم}. الدليل: ${stripTags(item.دليل)}`;
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'ar-SA';
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utter);
}

function smartSearch(query) {
    if (!query) return null;
    const normalizedQuery = normalize(query);
    const queryWords = normalizedQuery.split(' ').filter(word => word.length > 1);

    let bestMatchKey = null;
    let bestScore = 0;

    for (const k of keysCache) {
        const item = data[k];
        const normalizedK = normalize(k);
        let currentScore = 0;

        const searchableTerms = [normalizedK];
        if (item.مرادفات && Array.isArray(item.مرادفات)) {
            item.مرادفات.forEach(syn => searchableTerms.push(normalize(syn)));
        }

        if (searchableTerms.includes(normalizedQuery)) {
            currentScore = 1.0;
            bestMatchKey = k;
            break;
        }

        for (const queryWord of queryWords) {
            for (const term of searchableTerms) {
                if (term === queryWord) {
                    currentScore = Math.max(currentScore, 0.95);
                }
                else if (term.startsWith(queryWord)) {
                    currentScore = Math.max(currentScore, 0.85);
                }
                else if (term.includes(queryWord)) {
                    currentScore = Math.max(currentScore, 0.75);
                }
            }
        }

        for (const term of searchableTerms) {
            if (term.startsWith(normalizedQuery)) {
                currentScore = Math.max(currentScore, 0.9);
            }
            else if (term.includes(normalizedQuery)) {
                currentScore = Math.max(currentScore, 0.7);
            }
        }

        let totalTermWords = [];
        searchableTerms.forEach(term => totalTermWords = totalTermWords.concat(term.split(' ').filter(word => word.length > 1)));
        totalTermWords = [...new Set(totalTermWords)];

        let commonWordsCount = 0;
        for (const qWord of queryWords) {
            if (totalTermWords.includes(qWord)) {
                commonWordsCount++;
            }
        }
        if (queryWords.length > 0 && commonWordsCount > 0) {
            currentScore = Math.max(currentScore, (commonWordsCount / queryWords.length) * 0.6);
        }

        if (currentScore > bestScore) {
            bestScore = currentScore;
            bestMatchKey = k;
        }
    }
    return bestScore >= 0.5 ? bestMatchKey : null;
}

let questionInput, askBtn, clearBtn, suggestionsDiv, resultDiv, showAllBtn, exportBtn;
let chatHistory, chatInput, sendChatBtn, clearChatBtn, ttsToggleBtn;

function appendChat(text, who = 'bot') {
    const div = document.createElement('div');
    div.className = 'bubble ' + (who === 'user' ? 'user-bubble' : 'bot-bubble');
    if (who === 'user') {
        div.textContent = text;
    } else {
        div.innerHTML = text;
    }
    chatHistory.appendChild(div);
    chatHistory.scrollTop = chatHistory.scrollHeight;
}

function appendTyping() {
    const d = document.createElement('div');
    d.id = '__typing_indicator';
    d.className = 'bot-typing';
    d.textContent = 'جاري الكتابة...';
    chatHistory.appendChild(d);
    chatHistory.scrollTop = chatHistory.scrollHeight;
}

function removeTyping() {
    const el = document.getElementById('__typing_indicator');
    if (el) {
        el.remove();
    }
}

async function handleChatSend() {
    const userText = chatInput.value.trim();
    if (!userText) return;

    appendChat(userText, 'user');
    chatInput.value = '';

    appendTyping();

    await new Promise(resolve => setTimeout(resolve, 800));

    removeTyping();

    const matchedKey = smartSearch(userText);

    let replyText = '';
    if (matchedKey) {
        const item = data[matchedKey];
        replyText = `<strong>${matchedKey}</strong> — الحكم: ${item.حكم}<br><small style="color:var(--muted-text-color)">الدليل:</small> ${escapeHtml(item.دليل)}`;

        if (ttsEnabled) {
            const ttsContent = `الحكم في ${matchedKey}: ${item.حكم}. الدليل: ${stripTags(item.دليل)}`;
            const utter = new SpeechSynthesisUtterance(ttsContent);
            utter.lang = 'ar-SA';
            window.speechSynthesis.speak(utter);
        }
    } else {
        replyText = 'عذرًا، لم أجد تطابقًا واضحًا لسؤالك في قاعدة البيانات. هل يمكنك أن تسأل بطريقة أخرى أو عن مسألة محددة؟';
    }
    appendChat(replyText, 'bot');
}

function handleTtsToggle() {
    ttsEnabled = !ttsEnabled;
    ttsToggleBtn.textContent = ttsEnabled ? 'إيقاف الصوت' : 'تشغيل الصوت';
    ttsToggleBtn.setAttribute('aria-pressed', ttsEnabled);
    showToast(ttsEnabled ? 'تم تفعيل تشغيل الصوت' : 'تم تعطيل تشغيل الصوت');
    if (!ttsEnabled) {
        window.speechSynthesis.cancel();
    }
}

function handleClearChat() {
    chatHistory.innerHTML = '';
    appendChat('مرحباً بك! أنا مساعدك الفقهي. اسألني عن حكم أي مسألة شرعية وسأبحث لك عن الحكم والدليل.', 'bot');
    if (ttsEnabled) {
        const utter = new SpeechSynthesisUtterance('مرحباً بك! أنا مساعدك الفقهي. اسألني عن حكم أي مسألة شرعية وسأبحث لك عن الحكم والدليل.');
        utter.lang = 'ar-SA';
        window.speechSynthesis.speak(utter);
    }
}

function initializeEventListeners() {
    questionInput = document.getElementById('question');
    askBtn = document.getElementById('askBtn');
    clearBtn = document.getElementById('clearBtn');
    suggestionsDiv = document.getElementById('suggestions');
    resultDiv = document.getElementById('result');
    showAllBtn = document.getElementById('showAll');
    exportBtn = document.getElementById('exportBtn');

    chatHistory = document.getElementById('chatHistory');
    chatInput = document.getElementById('chatInput');
    sendChatBtn = document.getElementById('sendChat');
    clearChatBtn = document.getElementById('clearChat');
    ttsToggleBtn = document.getElementById('ttsToggle');

    askBtn.addEventListener('click', handleAsk);

    questionInput.addEventListener('keypress', e => {
        if (e.key === 'Enter') {
            e.preventDefault();
            handleAsk();
        }
    });

    clearBtn.addEventListener('click', () => {
        questionInput.value = '';
        suggestionsDiv.innerHTML = '';
        resultDiv.innerHTML = '<div class="welcome-message"><div class="welcome-icon"><svg viewBox="0 0 24 24" width="40" height="40"><path fill="currentColor" d="M12 3L1 12h3v8h6v-6h2v6h6v-8h3L12 3zm0 2.8L18 10v8h-2v-6H8v6H6v-8l6-4.2z"/></svg></div><div class="mini">اكتب سؤالاً واضغط "اعرف الحكم" أو اختر اقتراحاً.</div></div>';
        questionInput.focus();
    });

    questionInput.addEventListener('input', function () {
        const v = this.value.trim();
        suggestionsDiv.innerHTML = '';
        if (v.length === 0) {
            resultDiv.innerHTML = '<div class="welcome-message"><div class="welcome-icon"><svg viewBox="0 0 24 24" width="40" height="40"><path fill="currentColor" d="M12 3L1 12h3v8h6v-6h2v6h6v-8h3L12 3zm0 2.8L18 10v8h-2v-6H8v6H6v-8l6-4.2z"/></svg></div><div class="mini">اكتب سؤالاً واضغط "اعرف الحكم" أو اختر اقتراحاً لعرض الحكم والدليل.</div></div>';
            return;
        }
        const q = normalize(v);
        let count = 0;
        for (const k of keysCache) {
            const normalizedK = normalize(k);
            if (normalizedK.startsWith(q) || normalizedK.includes(q)) {
                const d = document.createElement('div');
                d.className = 'suggestion';
                d.textContent = k;
                d.addEventListener('click', () => {
                    questionInput.value = k;
                    suggestionsDiv.innerHTML = '';
                    renderResult(k);
                });
                suggestionsDiv.appendChild(d);
                if (++count >= 8) break;
            }
        }
    });

    function handleAsk() {
        const q = questionInput.value.trim();
        if (!q) {
            resultDiv.innerHTML = '<div class="welcome-message"><div class="mini">الرجاء كتابة سؤال في حقل البحث.</div></div>';
            return;
        }
        const matched = smartSearch(q);

        if (matched) {
            renderResult(matched);
            questionInput.value = matched;
            suggestionsDiv.innerHTML = '';
            return;
        }

        const randomSuggestions = keysCache.slice(0, 8).map(k => `• ${k} (${data[k].حكم})`).join('\n');
        resultDiv.innerHTML = `<div class="welcome-message"><div class="mini">لم أجد تطابقًا واضحًا لسؤالك. جرّب كلمة مفتاحية أخرى أو اختر من الاقتراحات أدناه:<br><pre style="color:var(--muted-text-color);white-space:pre-wrap;text-align:right">${randomSuggestions}</pre></div></div>`;
    }

    showAllBtn.addEventListener('click', () => {
        const list = keysCache.map(k => {
            const item = data[k];
            return `<div style="margin-bottom:12px;padding:12px;border-radius:10px;background:rgba(255,255,255,0.02)" class="animate__animated animate__fadeIn">
                <strong>${k}</strong>
                <div class="mini" style="margin-top:6px">${item.حكم}</div>
                <div class="proof" style="margin-top:8px;color:var(--muted-text-color)">${escapeHtml(item.دليل)}</div>
            </div>`;
        }).join('');
        resultDiv.innerHTML = `<div style="max-height:520px;overflow:auto;padding-right:6px">${list}</div>`;
    });

    exportBtn.addEventListener('click', () => {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'fiqh_data.json';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        showToast('تم تصدير البيانات بنجاح إلى fiqh_data.json');
    });

    sendChatBtn.addEventListener('click', handleChatSend);

    chatInput.addEventListener('keypress', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleChatSend();
        }
    });

    ttsToggleBtn.addEventListener('click', handleTtsToggle);

    clearChatBtn.addEventListener('click', handleClearChat);

    handleClearChat();
}

document.addEventListener('DOMContentLoaded', () => {
    initializeEventListeners();
    clearBtn.click();
});
